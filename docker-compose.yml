version: '3.8'

# SECURE CONFIGURATION with Caddy Reverse Proxy
#
# Security Features:
# - Services NOT exposed directly (no port mappings except Caddy)
# - All access goes through Caddy reverse proxy
# - API key authentication for ChromaDB and Ollama
# - Native auth for Redis and Neo4j
# - Network isolation
#
# Usage:
#   1. Set API_KEY in .env file
#   2. docker-compose -f docker-compose-secure.yml up -d
#   3. Access services through Caddy on localhost:8080

services:
  # =============================================================================
  # CADDY REVERSE PROXY - Single entry point with authentication
  # =============================================================================

  caddy:
    image: caddy:latest
    container_name: sa-caddy-proxy
    ports:
      - "${REMOTE_PORT}:${REMOTE_PORT}"  # Single entry point for all services
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - /mnt/secure/cert/secretai-yyzz:/app/cert:ro
      - caddy-data:/data
      - caddy-config:/config
    environment:
      - API_KEY=${API_KEY}
    networks:
      - agent-network
    restart: unless-stopped
    depends_on:
      - ollama
      - chromadb
      - neo4j
      - redis

  # =============================================================================
  # CORE SERVICES - NOT EXPOSED DIRECTLY (no ports section)
  # =============================================================================

  # Ollama - LLM service (accessible only through Caddy)
  ollama:
    image: ollama/ollama:latest
    container_name: sa-ollama
    runtime: nvidia
    privileged: true
    # NO PORTS - only accessible through Caddy
    volumes:
      - /mnt/secure/.ollama:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_NUM_GPU=${OLLAMA_NUM_GPU:-1}
      - OLLAMA_NUM_THREADS=${OLLAMA_NUM_THREADS:-8}
    entrypoint: /bin/bash
    command:
      - -c
      - |
        ollama serve &
        OLLAMA_PID=$!

        echo "Waiting for Ollama to start..."
        for i in {1..30}; do
          if ollama list > /dev/null 2>&1; then
            echo "Ollama is ready!"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done

        if ! ollama list | grep -q "llama3.3:70b"; then
          echo "Pulling llama3.3:70b model..."
          ollama pull llama3.3:70b
          echo "Model pulled successfully!"
        else
          echo "Model llama3.3:70b already exists"
        fi

        echo "Ollama ready with models!"
        wait $OLLAMA_PID
    networks:
      - agent-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped

  # ChromaDB - Vector database (accessible only through Caddy)
  chromadb:
    image: chromadb/chroma:latest
    container_name: sa-chromadb
    # NO PORTS - only accessible through Caddy
    volumes:
      - chroma-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
      - ANONYMIZED_TELEMETRY=FALSE
      # ChromaDB authentication via environment variables
      - CHROMA_SERVER_AUTH_CREDENTIALS=${API_KEY}
      - CHROMA_SERVER_AUTH_PROVIDER=chromadb.auth.token.TokenAuthenticationServerProvider
    networks:
      - agent-network
    restart: unless-stopped

  # Neo4j - Graph database (native auth enabled)
  neo4j:
    image: neo4j:latest
    container_name: sa-neo4j
    # NO PORTS - only accessible through Caddy
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-import:/var/lib/neo4j/import
      - neo4j-plugins:/plugins
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
    networks:
      - agent-network
    restart: unless-stopped

  # Redis - Caching (native auth enabled)
  redis:
    image: redis:latest
    container_name: sa-redis
    # NO PORTS - only accessible through Caddy
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory ${REDIS_MAX_MEMORY:-512mb} --maxmemory-policy allkeys-lru --requirepass ${REDIS_PASSWORD}
    networks:
      - agent-network
    restart: unless-stopped

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  caddy-data:
    driver: local
  caddy-config:
    driver: local
  ollama-data:
    driver: local
  chroma-data:
    driver: local
  neo4j-data:
    driver: local
  neo4j-logs:
    driver: local
  neo4j-import:
    driver: local
  neo4j-plugins:
    driver: local
  redis-data:
    driver: local

# =============================================================================
# NETWORKS - Isolated internal network
# =============================================================================

networks:
  agent-network:
    driver: bridge
    internal: false  # Set to true for complete isolation (no internet access)
